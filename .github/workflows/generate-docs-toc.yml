name: Generate Docs TOC
on:
  push:
    branches:
      - main  # æ ¹æ®ä½ çš„åˆ†æ”¯åç§°è°ƒæ•´
jobs:
  generate-toc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Generate TOC for code/ directory
        id: generate_toc
        run: |
          # éå† code/ ç›®å½•ä¸‹çš„æ‰€æœ‰ Markdown æ–‡ä»¶ï¼Œç”Ÿæˆç›®å½•ç»“æ„
          TOC="## ğŸ“š ä»£ç æ–‡æ¡£ç›®å½•\n\n"
          TOC+="ä»¥ä¸‹æ˜¯ `code/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡æ¡£ï¼š\n\n"
          
          # ä½¿ç”¨ find å‘½ä»¤æŸ¥æ‰¾æ‰€æœ‰ Markdown æ–‡ä»¶å¹¶ç”Ÿæˆé“¾æ¥
          while IFS= read -r -d '' file; do
            # ç§»é™¤ code/ å‰ç¼€å¹¶è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„
            REL_PATH="${file#code/}"
            # è·å–æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
            FILENAME=$(basename "$file" .md)
            # è·å–æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
            DIR=$(dirname "$REL_PATH")
            # è®¡ç®—ç¼©è¿›çº§åˆ«ï¼ˆåŸºäºç›®å½•æ·±åº¦ï¼‰
            DEPTH=$(echo "$DIR" | tr '/' '\n' | wc -l)
            # ç”Ÿæˆç¼©è¿›ï¼ˆä¸¤ä¸ªç©ºæ ¼ * æ·±åº¦ï¼‰
            INDENT=$(printf "%*s" $((DEPTH * 2)) "")
            # æ·»åŠ åˆ°ç›®å½•
            TOC+="${INDENT}- [${FILENAME}](${file})\n"
          done < <(find code -name "*.md" -print0 | sort -z)
          
          # ä¿å­˜ç›®å½•åˆ°ç¯å¢ƒå˜é‡
          echo "TOC<<EOF" >> $GITHUB_ENV
          echo "$TOC" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: Update README with TOC
        uses: technote-space/replace-in-file-action@v1
        with:
          files: README.md
          regexp: '(<!-- START CODE TOC -->)([\s\S]*)(<!-- END CODE TOC -->)'
          replace: '$1\n${{ env.TOC }}\n$3'
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update code documentation TOC" || echo "No changes to commit"
          git push
